-- Load the schematic data from the file
local function load_schematic()
    -- Try to open the file
    local file = fs.open("schematic.lua", "r")
    if not file then
        print("Error: schematic.lua file not found.")
        return nil
    end

    -- Read all content from the file
    local schematic_data = file.readAll()
    file.close()

    -- Replace the commas after the last block to avoid issues with table parsing
    schematic_data = schematic_data:gsub(",%s*}", " }")

    -- Execute the content of the file and capture the schematic data
    local schematic, err = load(schematic_data, "schematic", "t", _G)
    if not schematic then
        print("Error loading schematic: " .. (err or "Unknown error"))
        return nil
    end

    -- Execute the loaded Lua code to return the schematic table
    return schematic()
end

-- Helper function to place a block based on the block name
local function place_block(block)
    -- The 'block' variable here will be a string, such as 'dirt', 'stone', etc.
    -- The turtle automatically knows how to place most blocks, so we can directly use it.
    if turtle.detectDown() then
        -- If there's a block below, we won't place a new one, just move on
        return
    end
    if turtle.getItemCount() > 0 then
        turtle.placeDown()
    else
        print("Not enough items in inventory to place block: " .. block)
    end
end

-- Function to move the turtle to the required coordinates relative to its starting position
local function move_to(x, y, z)
    -- Get the current position (relative to where the turtle started)
    local current_x, current_y, current_z = 0, 0, 0 -- Assuming initial coordinates (adjust as needed)

    -- Calculate the relative movement required
    local dx = x - current_x
    local dy = y - current_y
    local dz = z - current_z

    -- Move in the X direction (left or right)
    if dx > 0 then
        for i = 1, dx do
            turtle.forward()
        end
    elseif dx < 0 then
        for i = 1, -dx do
            turtle.back()
        end
    end

    -- Move in the Y direction (up or down)
    if dy > 0 then
        for i = 1, dy do
            turtle.up()
        end
    elseif dy < 0 then
        for i = 1, -dy do
            turtle.down()
        end
    end

    -- Move in the Z direction (left or right, or forwards/backwards)
    if dz > 0 then
        for i = 1, dz do
            turtle.forward()
        end
    elseif dz < 0 then
        for i = 1, -dz do
            turtle.back()
        end
    end
end

-- Build the schematic block-by-block
local function build_schematic(schematic)
    if not schematic then
        print("Schematic not loaded properly.")
        return
    end

    for _, block in ipairs(schematic) do
        -- Move the turtle to the block's position
        move_to(block.x, block.y, block.z)

        -- Place the block
        place_block(block.block)
    end
end

-- Load the schematic and start building
local schematic = load_schematic()
if schematic then
    build_schematic(schematic)
else
    print("Failed to load schematic.")
end
